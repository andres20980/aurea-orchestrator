apiVersion: batch/v1
kind: Job
metadata:
  name: aurea-db-migration
  namespace: aurea-orchestrator
  labels:
    app.kubernetes.io/name: aurea-orchestrator
    app.kubernetes.io/component: migration
    app.kubernetes.io/part-of: aurea-orchestrator
  annotations:
    # Helm hook annotations (if using Helm)
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        app.kubernetes.io/name: aurea-orchestrator
        app.kubernetes.io/component: migration
        app.kubernetes.io/part-of: aurea-orchestrator
    spec:
      restartPolicy: OnFailure
      serviceAccountName: aurea-orchestrator
      containers:
      - name: migration
        image: aurea-orchestrator-api:latest
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - |
          echo "Starting database migration..."
          # Example migration commands (adjust based on your framework)
          # For Django: python manage.py migrate
          # For Alembic: alembic upgrade head
          # For Flask-Migrate: flask db upgrade
          python manage.py migrate --noinput
          echo "Migration completed successfully"
        envFrom:
        - configMapRef:
            name: aurea-orchestrator-config
        - secretRef:
            name: aurea-orchestrator-secret
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tmp
        emptyDir: {}
